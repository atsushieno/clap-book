
# CLAPについて

## CLAPとは

CLAPは2022年6月にバージョン1.0が公開されて幅広く認知されるようになった、新しいオーディオプラグイン機構（あるいはオーディオプラグインフォーマット）です。比較できる技術としては、SteinbergのVST (2, 3)、AppleのAudioUnit (v2, v3)、LV2などが挙げられます。

## CLAPの特徴

ここでは、CLAPプロジェクトが特徴としてアピールしているポイントをいくつか紹介します。本書で解説する要点とは特に関係がありません。本書では主にCLAP開発のためのAPIや勘所を解説します。

### 商用開発に向いているライセンス

CLAPはMITライセンスで利用可能です。VST3の開発に必要な vst3_sdk はGPLv3とSteinbergの商用ライセンスとのデュアルライセンスで公開されており、VST2はオープンソースでは公開されませんでした。AudioUnitはAppleのプロプラエタリなSDKの一部であり、Appleプラットフォーム（macOS、iOS）でしか利用できません。

vst3_sdkをGPLv3ライセンスに基づいて利用するということは、これを利用して開発したVST3プラグインのソースコードは公開して誰でも利用できるようにしなければならないということであり、商用製品を販売してもそのソースコードを誰でもビルドでき、そのバイナリプログラムを頒布・販売できるということになります。これは商用プラグイン開発者にとっては実質的に商用ライセンスで公開されているのと同様です。CLAPのリベラルなライセンスは、実質的にはSteinbergの商用ライセンスからの解放であると評価できます。

LV2はCLAPと同様、商用利用にやさしいISCライセンスで提供されています。GNUフリーソフトウェアの世界では、VST3もLV2もCLAPも特に問題なく受け入れられています。

### モダンな機能のサポート

オーディオプラグインに求められる機能は多様化しています。オーディオプラグインはインストゥルメントあるいはエフェクトとして機能するものであり、オーディオプラグイン以前はMIDI 1.0がそれらを部分的に実現していたものですが、2022年のオーディオプラグインシステムには、MIDI 1.0が実現していた機能に加えて、32ビットfloat（ときに64ビットfloat）でのパラメーター、ノート別パラメーター（MIDIであればMPEなど）、ノートのアーティキュレーション（ノート別の特殊表現）、アンビソニックや3Dのような多チャンネルオーディオなど、さまざまな追加機能が求められるようになっています。CLAPはこれらの表現を可能にしていますし、また新機能を追加しやすいような拡張機能の仕組みが整備されています（この点はVST3やLV2と同様です）。

2020年にはMIDI 2.0の正式版が公開され、MIDI 1.0および2.0との適切な相互運用性も求められています。特にMIDI入力メッセージを自分のイベント機構のメッセージに変換するVST3の仕組みが、この点でうまく機能していない側面があり、CLAPは問題が生じないように設計されています。

### マルチコアCPUの効率的なサポート

CLAPはCPUのマルチコアの効率的な利用をアプリケーションのコーディングで可能にできる2020年代にふさわしい設計になっています。詳しくはthread-pool拡張機能の節で言及します。

### 高速なプラグインのスキャン

CLAP開発チームは、CLAPのプラグインスキャンではプラグインのインスタンスを生成する必要がないため、プラグインのスキャンは高速に完了すると主張しています。これについてはCLAPプラグイン開発の章で改めて解説・評価します。

### プラグインの状態を破壊的に変更しないオートメーションのサポート

DAWでプラグインパラメーターをリニアに変更する、いわゆるオートメーションの仕組みを利用すると、一般的にはオートメーションの完了後にパラメーターの状態は変更されたままの「破壊された」状態になります。CLAPではパラメーターの変更の由来がユーザーの操作によるものかオートメーションによるものかといった情報をホストとプラグインの間で伝達でき、オートメーション完了後にパラメーターを「元の値」に戻せるようになります。

これはDAWの実装の仕方しだいではありますが、本書の序文でも書いたとおり、筆者はこのような（現時点で）CLAPにしか存在しない機能に依存した楽曲の打ち込みは推奨しません。DAWのCLAPサポートなどに問題があった場合、逃げ場がなくなってしまうからです。

### オープンなコミュニティ

CLAPはBitwig Studio DAWを発売しているドイツのBitwig社とドイツのu-he社（Heckmann Audio GmbH）が中心になって設計・開発しています。CLAPはコミュニティ主導の規格である、とCLAP開発チームは主張しています。CLAPには一般開発者向けのDiscordサーバー（The Audio Programmerの#clap）などがあり、公開リポジトリでのissueやpull requestを通じたやり取りも可能です。

VST3を開発しているSteinbergやAudioUnitを開発しているAppleは、このようなコミュニティを開発者向けフォーラム以外では特に公開していないので、相対的にCLAPはコミュニティのやり取りが活発であると評価できるかもしれません。もっとも、コミュニティのDiscordサーバーに開発チームのメンバーは参加していません。LV2にはオープンなコミュニティが存在し、LV2の開発者も含めてやり取りできます。ただし、2022年でもメーリングリストとIRCが主な手段であるようです。LV2はgithubとgitlabにリポジトリが存在し、開発者個人とのやり取りはこれらでも可能です。

一方でCLAPにはBitwig社とu-he社の開発者のみがアクセスできる開発者限定のDiscordサーバーの存在もissuesのやり取りから認知され（たとえば https://github.com/free-audio/clap/issues/147#issuecomment-1206654119 ）、完全にオープンなコミュニティというわけではありません。githubのfreeaudio/clapリポジトリで公式サイトとされているcleveraudio.orgもu-heの代表であるUrs Heckmannの個人サイトで、ソースは公開されていません。LV2はサイトのソースも公開されており、pull requestも送れます。

## CLAP正式版（バージョン1.0）が登場した背景とその意義

CLAPは2022年6月に正式版が公開されましたが、CLAPの開発そのものの歴史は長く、2014年にgithubで開発が始まっており、Hacker Newsでも作者自らコメントを求めるかたちで記事化されています。CLAPが急速に注目されるようになったのは、プラグインベンダーであるu-heが、VST3を置き換えうる次世代フォーマットとして期待し、開発者が所属するBitwigと提携してプラグインのエコシステムを作り上げるという目論見で、大々的にアナウンスするようになったためです。

u-heで次世代フォーマットを求めるようになった背景には、SteinbergがVST3への移行促進のために行ったVST2のサポート廃止とVST2 SDKの非公開化があると考えられます。これはVST2 SDKをバンドルしているさまざまなVSTプラグインプロジェクトのGitHubリポジトリに対してSteinbergが削除要求を送るほど徹底していました。従前からVST2プラグインを開発していたベンダーは引き続きVST2プラグインを開発できますが、新たな開発者はSteinbergのSDKをダウンロードできなくなったので、VST2 SDKを利用した製品が公開できないということになりました。（LMMSプロジェクトで使われていた、VST2互換のAPIをオープンソースで実装したVeSTigeというコードが存在するので、これを利用しているプロジェクトは今でも存在します。）

一方で移行先となるはずのVST3は、VST2と比べると複雑で根本的なプログラムの書き換えが必要になり、その努力が必要になる割にはVST3非対応DAWも多い状態でした（ここには、VST3はホスト側の仕様があまり明確にドキュメントされていないという問題も影響したと考えられます）。VSTが特にWindowsプラットフォームでは支配的なプラグインフォーマットであることを考えると、驚くほど浸透していませんでした。「VST2の次をVST3の代わりにCLAPで取りに行こう」という計画が立ち上がっても、不思議ではなかったといえます。もっともVST3は2022年にはだいぶDAWでサポートされるようになりプラグイン市場でも普及してきたので（たとえばKontaktなどのNative Instruments製品がVST3への移行を完了しています）、VST3が座るべきポジションを奪うことにはならなかったというべきかもしれません。

オーディオプラグインフォーマットのエコシステムが成立するためには、サポートするDAWとサポートするプラグインの双方が揃っていることが不可欠です。DAWを開発するBitwigとプラグインベンダーとしてそれなりのポジションにあるu-heが提携して促進していることには一定の強みがあります。特にLV2はこの面では強くなかったので、LV2が獲得できそうな立ち位置に届きつつあるともいえます（一方でLV2の主戦場であるLinuxデスクトップ環境のオープンソースプラグイン市場ではVST3も使われつつあります）。

いずれにせよ、オーディオプラグインフォーマットにとって、バージョン1.0公開は大きな意味をもちます。プラグインフォーマットはプラグインベンダーとDAWベンダーが採用してその規格に則って製品を開発し販売することで利用されるようになります。そこではABIすなわちバイナリレベルの互換性が絶対に必要になります。プラグインAPIを破壊的に変更することはできなくなります。互換性のないAPIには、DAWベンダーもプラグインベンダーも追従してくれません。逆にいえば、DAWベンダーもプラグインベンダーも、ABIが安定化したのであれば、安心してそのプラグインフォーマットをサポートできるようになります。

## 他のプラグインフォーマットとの比較

オーディオプラグインフォーマットとしてはVST、AudioUnit、LV2といったものが存在します。どのフォーマットにもさまざまな長所・短所があります。簡単に列挙しておきます。

- VST2: C/C++、多重継承による拡張機能、Win/Mac用、20世紀からありプラグインは最多、プロプラエタリライセンス、もうSDKをダウンロードできない
- VST3: C++、COMライクなクエリーインターフェース（やや難）、多数のプラグイン、OSS (steinbergmedia/vst3sdk, GPLv3) or 商用ライセンス
- AUv2: Objective-C / C++、GitHub上にソースがある (apple/AudioUnitSDK - 完全性は不明)
- AUv3: Objective-C / C++、Mac or iOS、App Extensionによるプロセス分離、 ソースは無さそう
- LV2: C、クエリインターフェースによる拡張機能（やや難）、OSS (gitlab/lv2/lv2, ISCライセンス)
- CLAP: C, クエリインターフェースによる拡張機能、OSS (free-audio/clap, MIT)

AppleのAudioUnit以外はデスクトップのクロスプラットフォーム（Win/Mac/Linux）用と考えて良いです（VSTがLinuxをサポートするようになったのはだいぶ最近になってからではあります）。

この他、ReaperのReaPlugやProTools用のAAXなど、汎用ではなく特定のDAW専用のプラグインフォーマットで著名なものもいくつかあります。


